// Generated by CoffeeScript 1.3.3
var async, commonOptions, commonUsage, extend, getOptions, loadPlugins, logger, options, preview, usage, util, _ref, _ref1;

async = require('async');

util = require('util');

_ref = require('../common'), logger = _ref.logger, extend = _ref.extend;

_ref1 = require('./common'), getOptions = _ref1.getOptions, commonUsage = _ref1.commonUsage, commonOptions = _ref1.commonOptions, loadPlugins = _ref1.loadPlugins;

usage = "\nusage: wintersmith preview [options]\n\noptions:\n\n  -p, --port [port]             port to run server on (defaults to 8080)\n  " + commonUsage + "\n\n  all options can also be set in the config file\n\nexamples:\n\n  preview using a config file (assuming config.json is found in working directory):\n  $ wintersmith preview\n";

options = {
  port: {
    alias: 'p',
    "default": 8080
  }
};

extend(options, commonOptions);

preview = function(argv) {
  var server;
  server = require('../server');
  logger.info('starting preview server');
  return async.waterfall([
    async.apply(getOptions, argv), function(options, callback) {
      return loadPlugins(options.plugins, function(error) {
        return callback(error, options);
      });
    }, function(options, callback) {
      return server.run(options, callback);
    }
  ], function(error) {
    if (error) {
      return logger.error(error.message, error);
    }
  });
};

module.exports = preview;

module.exports.usage = usage;

module.exports.options = options;
